<div class="flex flex-col gap-6">
  <div class="flex flex-row justify-between items-center">
    <h1 class="text-3xl font-semibold text-surface-900 dark:text-surface-0">
      {{ isPredicting ? 'Predicted Attendance' : 'Attendance Details' }}
    </h1>
    <div>
      @if (isPredicting) {
        <p-button label="Reset" icon="pi pi-refresh" (click)="resetPrediction()" styleClass="p-button-outlined" />
      }
      <p-button 
        label="Predict" 
        icon="pi pi-lightbulb" 
        (click)="openPredictionDialog()" 
        [loading]="isLoadingPredictionData"
        styleClass="p-button-outlined ml-2" />
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" [@cardAnimation]="attendanceDetails.length">
    @for (detail of attendanceDetails; track detail.courseCode) {
      <p-card styleClass="flex flex-col h-full">
        <div class="flex flex-col justify-between p-4 h-full">
          <!-- Top section: Details -->
          <div>
            <h2 class="text-xl font-bold text-surface-800 dark:text-surface-100">{{ detail.courseTitle }}</h2>
            <p class="text-sm text-surface-500 dark:text-surface-400">({{ detail.courseCode }}) - {{ detail.courseCategory }}</p>
          </div>
          
          <!-- Bottom section: Stats -->
          <div class="flex justify-between items-end pt-4">
            <!-- Left side: Pills -->
            <div class="flex flex-col gap-2 items-start">
              <span class="attendance-pill bg-green-500/20 text-green-300">
                Attended: {{ getAttendedCount(detail) }}
              </span>
              <span class="attendance-pill bg-red-500/20 text-red-300">
                Absent: {{ getAbsentCount(detail) }}
              </span>
              <span class="attendance-pill bg-primary-500/20 text-primary-300">
                Total: {{ getTotalConducted(detail) }}
              </span>
            </div>

            <!-- Right side: Margin/Required and Percentage -->
            <div class="text-right flex flex-col items-center">
              @let percentage = getAttendancePercentage(detail);
              @let margin = getMarginInfo(detail);
              <div class="text-5xl font-bold" [ngClass]="getAttendanceColor(percentage)">
                {{ margin.value }}
              </div>
              <div class="text-xs font-semibold text-surface-500 dark:text-surface-400 uppercase tracking-wider">
                {{ margin.label }}
              </div>
              <div class="text-sm text-surface-500 dark:text-surface-400 mt-1">
                {{ percentage | number: '1.2-2' }}%
              </div>
            </div>
          </div>
        </div>
      </p-card>
    }
  </div>
</div>

<!-- Prediction Dialog -->
<p-dialog 
  header="Predict Attendance" 
  [(visible)]="showPredictionDialog" 
  [modal]="true" 
  [style]="{width: '90vw', maxWidth: '25rem'}"
  [draggable]="false"
  [resizable]="false">
    <div class="flex flex-col gap-6 pt-4">
      <p class="text-surface-600 dark:text-surface-300">Select the start and end date for your planned leave.</p>
      <p-floatLabel>
        <p-datePicker
          [(ngModel)]="rangeDates"
          selectionMode="range"
          inputId="leave_dates"
          dateFormat="dd/mm/yy"
          styleClass="w-full"
          [touchUI]="isMobile"
          [showIcon]="true">
        </p-datePicker>
        <label for="leave_dates">Leave Dates</label>
      </p-floatLabel>
    </div>
    <div class="flex justify-end gap-2 mt-6">
      <p-button label="Cancel" (click)="showPredictionDialog = false" styleClass="p-button-text"></p-button>
      <p-button label="OK" (click)="runPrediction()" [disabled]="!rangeDates[0] || !rangeDates[1]"></p-button>
    </div>
</p-dialog>

