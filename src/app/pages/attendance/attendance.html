<div class="flex flex-col gap-6">
  <div class="flex flex-row justify-between items-center">
    <h1 class="text-3xl font-semibold text-surface-900 dark:text-surface-0">
      {{ isPredicting ? 'Predicted Attendance' : 'Attendance Details' }}
    </h1>
    <div>
      @if (isPredicting) {
        <p-button label="Reset" icon="pi pi-refresh" (click)="resetPrediction()" variant="outlined" severity="warn" />
      }
      <p-button 
        label="Predict" 
        icon="pi pi-lightbulb" 
        (click)="openPredictionDialog()" 
        [loading]="isLoadingPredictionData"
        styleClass="p-button-outlined ml-2" />
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" [@cardAnimation]="attendanceDetails.length">
    @for (detail of attendanceDetails; track detail.courseCode) {
      <p-card styleClass="flex flex-col h-full">
        <div class="flex flex-col justify-between p-4 h-full">
          <!-- Top section: Details -->
          <div>
            <h2 class="text-xl font-bold text-surface-800 dark:text-surface-100">{{ detail.courseTitle }}</h2>
            <p class="text-sm text-surface-500 dark:text-surface-400">({{ detail.courseCode }}) - {{ detail.courseCategory }}</p>
          </div>
          
          <!-- Bottom section: Stats -->
          <div class="flex justify-between items-end pt-4">
            <!-- Left side: Pills -->
            <div class="flex flex-col gap-2 items-start">
              <span class="attendance-pill bg-green-500/20 text-green-300">
                Attended: {{ getAttendedCount(detail) }}
              </span>
              <span class="attendance-pill bg-red-500/20 text-red-300">
                Absent: {{ getAbsentCount(detail) }}
              </span>
              <span class="attendance-pill bg-primary-500/20 text-primary-300">
                Total: {{ getTotalConducted(detail) }}
              </span>
            </div>

            <!-- Right side: Margin/Required and Percentage -->
            <div class="text-right flex flex-col items-center">
              @let percentage = getAttendancePercentage(detail);
              @let margin = getMarginInfo(detail);
              <div class="text-5xl font-bold" [ngClass]="getAttendanceColor(percentage)">
                {{ margin.value }}
              </div>
              <div class="text-xs font-semibold text-surface-500 dark:text-surface-400 uppercase tracking-wider">
                {{ margin.label }}
              </div>
              <div class="text-sm text-surface-500 dark:text-surface-400 mt-1">
                {{ percentage | number: '1.2-2' }}%
              </div>
            </div>
          </div>
        </div>
      </p-card>
    }
  </div>
</div>

<!-- Prediction Dialog -->
<p-dialog 
  header="Predict Attendance" 
  [(visible)]="showPredictionDialog" 
  [modal]="true" 
  [style]="{width: '95vw', maxWidth: '450px'}"
  [draggable]="false"
  [resizable]="false"
  [closable]="true"
  [breakpoints]="{'768px': '100vw'}"
  styleClass="surface-overlay"
  (onHide)="closePredictionDialog()">
  
  <div class="flex flex-col gap-4">
    <p class="text-sm md:text-base text-surface-600 dark:text-surface-300 mb-2">
      Select the start and end date for your planned leave.
    </p>
    
    <div class="w-full">
      <p-floatLabel>
        <p-datePicker
          [(ngModel)]="rangeDates"
          selectionMode="range"
          inputId="leave_dates"
          dateFormat="dd/mm/yy"
          styleClass="w-full"
          [iconDisplay]="'input'"
          [showIcon]="true"
          [appendTo]="'body'"
          [style]="{'width': '100%'}"
          placeholder="Select date range">
        </p-datePicker>
        <label for="leave_dates">Leave Dates</label>
      </p-floatLabel>
    </div>
    
    @if (rangeDates && rangeDates.length === 2 && rangeDates[0] && rangeDates[1]) {
      <div class="bg-surface-100 dark:bg-surface-800 rounded-lg p-3 mt-2">
        <div class="text-xs md:text-sm text-surface-600 dark:text-surface-400">
          <span class="font-semibold">Selected period:</span>
        </div>
        <div class="text-sm md:text-base font-medium text-surface-900 dark:text-surface-100 mt-1">
          {{ rangeDates[0] | date:'dd MMM yyyy' }} - {{ rangeDates[1] | date:'dd MMM yyyy' }}
        </div>
        @let dayCount = ((rangeDates[1].getTime() - rangeDates[0].getTime()) / (1000 * 3600 * 24)) + 1;
        <div class="text-xs text-surface-500 dark:text-surface-400 mt-1">
          {{ dayCount }} day{{ dayCount > 1 ? 's' : '' }} of leave
        </div>
      </div>
    }
  </div>
  
  <ng-template pTemplate="footer">
    <div class="flex flex-col sm:flex-row justify-end gap-2 w-full">
      <p-button 
        label="Cancel" 
        (click)="closePredictionDialog()" 
        styleClass="p-button-text w-full sm:w-auto"
        [style]="{'min-width': '100px'}">
      </p-button>
      <p-button 
        label="Predict" 
        icon="pi pi-chart-line"
        (click)="runPrediction()" 
        [disabled]="!areDatesSelected"
        styleClass="w-full sm:w-auto"
        [style]="{'min-width': '100px'}">
      </p-button>
    </div>
  </ng-template>
</p-dialog>